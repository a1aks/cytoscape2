package cytoscape.visual.ui;

import cytoscape.Cytoscape;

import cytoscape.data.CyAttributes;

import cytoscape.data.attr.CountedIterator;
import cytoscape.data.attr.MultiHashMap;

import cytoscape.visual.VisualPropertyType;

import cytoscape.visual.calculators.Calculator;

import cytoscape.visual.mappings.ContinuousMapping;
import cytoscape.visual.mappings.ObjectMapping;
import cytoscape.visual.mappings.continuous.ContinuousMappingPoint;

import org.jdesktop.swingx.JXMultiThumbSlider;

import java.awt.Dimension;
import java.awt.Font;
import java.awt.event.MouseEvent;
import java.awt.event.MouseListener;

import java.util.ArrayList;

import javax.swing.JDialog;
import javax.swing.JPanel;


/**
 * DOCUMENT ME!
 *
 * @author $author$
  */
public abstract class MappingEditorPanel2 extends JPanel {
    protected VisualPropertyType type;
    protected double maxValue;
    protected double minValue;
    protected ArrayList<ContinuousMappingPoint> allPoints;

    /** Creates new form ContinuousMapperEditorPanel */
    public MappingEditorPanel2(VisualPropertyType type) {
        this.type = type;
        initComponents();
        setVisualPropLabel();

        setAttrComboBox();
    }

    protected void setVisualPropLabel() {
        this.visualPropertyLabel.setText("Visual Property: " + type.getName());
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */

    // <editor-fold defaultstate="collapsed" desc=" Generated Code ">
    private void initComponents() {
        rangeSettingPanel = new javax.swing.JPanel();
        pivotLabel = new javax.swing.JLabel();
        addButton = new javax.swing.JButton();
        deleteButton = new javax.swing.JButton();
        valueSpinner = new javax.swing.JSpinner();
        colorButton = new javax.swing.JButton();
        rangeEditorPanel = new javax.swing.JPanel();
        slider = new org.jdesktop.swingx.JXMultiThumbSlider();
        attrNameLabel = new javax.swing.JLabel();
        attributeComboBox = new javax.swing.JComboBox();
        iconPanel = new IconPanel(type);
        visualPropertyLabel = new javax.swing.JLabel();

        valueSpinner.setEnabled(false);

        rotaryEncoder = new JXMultiThumbSlider();

        iconPanel.setPreferredSize(new Dimension(60, 1));

        this.setBorder(
            javax.swing.BorderFactory.createTitledBorder(
                null,
                "Continuous Mapping for " + type.getName(),
                javax.swing.border.TitledBorder.DEFAULT_JUSTIFICATION,
                javax.swing.border.TitledBorder.DEFAULT_POSITION,
                new java.awt.Font("SansSerif", Font.BOLD, 12),
                new java.awt.Color(0, 0, 0)));

        rangeSettingPanel.setBorder(
            javax.swing.BorderFactory.createTitledBorder(
                null,
                "Range Setting",
                javax.swing.border.TitledBorder.DEFAULT_JUSTIFICATION,
                javax.swing.border.TitledBorder.DEFAULT_POSITION,
                new java.awt.Font("SansSerif", 1, 10),
                new java.awt.Color(0, 0, 0)));
        pivotLabel.setFont(new java.awt.Font("SansSerif", 1, 12));
        pivotLabel.setForeground(java.awt.Color.darkGray);
        pivotLabel.setText("Pivot:");

        addButton.setText("Add");
        addButton.setMargin(new java.awt.Insets(2, 2, 2, 2));
        addButton.addActionListener(
            new java.awt.event.ActionListener() {
                public void actionPerformed(java.awt.event.ActionEvent evt) {
                    addButtonActionPerformed(evt);
                }
            });

        deleteButton.setText("Delete");
        deleteButton.setMargin(new java.awt.Insets(2, 2, 2, 2));
        deleteButton.addActionListener(
            new java.awt.event.ActionListener() {
                public void actionPerformed(java.awt.event.ActionEvent evt) {
                    deleteButtonActionPerformed(evt);
                }
            });

        rangeEditorPanel.setBorder(
            javax.swing.BorderFactory.createTitledBorder(
                null,
                "Range Editor",
                javax.swing.border.TitledBorder.DEFAULT_JUSTIFICATION,
                javax.swing.border.TitledBorder.DEFAULT_POSITION,
                new java.awt.Font("SansSerif", 1, 10),
                new java.awt.Color(0, 0, 0)));
        slider.setMaximumValue(100.0F);
        rotaryEncoder.setMaximumValue(100.0F);

        org.jdesktop.layout.GroupLayout sliderLayout = new org.jdesktop.layout.GroupLayout(slider);
        slider.setLayout(sliderLayout);
        sliderLayout.setHorizontalGroup(
            sliderLayout.createParallelGroup(
                org.jdesktop.layout.GroupLayout.LEADING).add(0, 486,
                Short.MAX_VALUE));
        sliderLayout.setVerticalGroup(
            sliderLayout.createParallelGroup(
                org.jdesktop.layout.GroupLayout.LEADING).add(0, 116,
                Short.MAX_VALUE));

        attrNameLabel.setFont(new java.awt.Font("SansSerif", 1, 14));
        attrNameLabel.setForeground(java.awt.Color.darkGray);
        attrNameLabel.setText("Attribute Name");

        //        org.jdesktop.layout.GroupLayout iconPanelLayout = new org.jdesktop.layout.GroupLayout(iconPanel);
        //        iconPanel.setLayout(iconPanelLayout);
        //        iconPanelLayout.setHorizontalGroup(
        //            iconPanelLayout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
        //            .add(org.jdesktop.layout.GroupLayout.TRAILING, rotaryEncoder, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 84, Short.MAX_VALUE)
        //        );
        //        iconPanelLayout.setVerticalGroup(
        //            iconPanelLayout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING)
        //            .add(org.jdesktop.layout.GroupLayout.TRAILING, rotaryEncoder, org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 146, Short.MAX_VALUE)
        //        );
        org.jdesktop.layout.GroupLayout jXMultiThumbSlider1Layout = new org.jdesktop.layout.GroupLayout(rotaryEncoder);
        rotaryEncoder.setLayout(jXMultiThumbSlider1Layout);
        jXMultiThumbSlider1Layout.setHorizontalGroup(
            jXMultiThumbSlider1Layout.createParallelGroup(
                org.jdesktop.layout.GroupLayout.LEADING).add(0, 84,
                Short.MAX_VALUE));
        jXMultiThumbSlider1Layout.setVerticalGroup(
            jXMultiThumbSlider1Layout.createParallelGroup(
                org.jdesktop.layout.GroupLayout.LEADING).add(0, 65,
                Short.MAX_VALUE));

        visualPropertyLabel.setFont(new java.awt.Font("SansSerif", 1, 14));
        visualPropertyLabel.setForeground(java.awt.Color.darkGray);

        org.jdesktop.layout.GroupLayout rangeSettingPanelLayout = new org.jdesktop.layout.GroupLayout(rangeSettingPanel);
        rangeSettingPanel.setLayout(rangeSettingPanelLayout);
        rangeSettingPanelLayout.setHorizontalGroup(
            rangeSettingPanelLayout.createParallelGroup(
                org.jdesktop.layout.GroupLayout.LEADING).add(
                rangeSettingPanelLayout.createSequentialGroup().addContainerGap().add(valueSpinner,
                    org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 67,
                    org.jdesktop.layout.GroupLayout.PREFERRED_SIZE).addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED,
                    118, Short.MAX_VALUE).add(addButton,
                    org.jdesktop.layout.GroupLayout.PREFERRED_SIZE, 55,
                    org.jdesktop.layout.GroupLayout.PREFERRED_SIZE).addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED).add(deleteButton).add(10,
                    10, 10)));
        rangeSettingPanelLayout.setVerticalGroup(
            rangeSettingPanelLayout.createParallelGroup(
                org.jdesktop.layout.GroupLayout.LEADING).add(
                rangeSettingPanelLayout.createParallelGroup(
                    org.jdesktop.layout.GroupLayout.BASELINE).add(valueSpinner,
                    org.jdesktop.layout.GroupLayout.PREFERRED_SIZE,
                    org.jdesktop.layout.GroupLayout.DEFAULT_SIZE,
                    org.jdesktop.layout.GroupLayout.PREFERRED_SIZE).add(deleteButton).add(addButton,
                    org.jdesktop.layout.GroupLayout.PREFERRED_SIZE,
                    org.jdesktop.layout.GroupLayout.DEFAULT_SIZE,
                    org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)));

        org.jdesktop.layout.GroupLayout layout = new org.jdesktop.layout.GroupLayout(this);
        this.setLayout(layout);
        layout.setHorizontalGroup(
            layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING).add(
                layout.createSequentialGroup().add(iconPanel,
                    org.jdesktop.layout.GroupLayout.PREFERRED_SIZE,
                    org.jdesktop.layout.GroupLayout.DEFAULT_SIZE,
                    org.jdesktop.layout.GroupLayout.PREFERRED_SIZE).addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED).add(slider,
                    org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 269,
                    Short.MAX_VALUE).addContainerGap()).add(rangeSettingPanel,
                org.jdesktop.layout.GroupLayout.DEFAULT_SIZE,
                org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, Short.MAX_VALUE));
        layout.setVerticalGroup(
            layout.createParallelGroup(org.jdesktop.layout.GroupLayout.LEADING).add(
                layout.createSequentialGroup().add(
                    layout.createParallelGroup(
                        org.jdesktop.layout.GroupLayout.TRAILING).add(slider,
                        org.jdesktop.layout.GroupLayout.DEFAULT_SIZE, 145,
                        Short.MAX_VALUE).add(iconPanel,
                        org.jdesktop.layout.GroupLayout.DEFAULT_SIZE,
                        org.jdesktop.layout.GroupLayout.DEFAULT_SIZE,
                        Short.MAX_VALUE)).addPreferredGap(org.jdesktop.layout.LayoutStyle.RELATED).add(rangeSettingPanel,
                    org.jdesktop.layout.GroupLayout.PREFERRED_SIZE,
                    org.jdesktop.layout.GroupLayout.DEFAULT_SIZE,
                    org.jdesktop.layout.GroupLayout.PREFERRED_SIZE)));
    } // </editor-fold>               

    abstract protected void deleteButtonActionPerformed(
        java.awt.event.ActionEvent evt);

    abstract protected void addButtonActionPerformed(
        java.awt.event.ActionEvent evt);

    private void setAttrComboBox() {
        // Reset
        attributeComboBox.removeAllItems();

        final CyAttributes attr;
        final Calculator calc;

        if (type.isNodeProp()) {
            attr = Cytoscape.getNodeAttributes();
            calc = Cytoscape.getVisualMappingManager()
                            .getVisualStyle()
                            .getNodeAppearanceCalculator()
                            .getCalculator(type);
        } else {
            attr = Cytoscape.getEdgeAttributes();
            calc = Cytoscape.getVisualMappingManager()
                            .getVisualStyle()
                            .getEdgeAppearanceCalculator()
                            .getCalculator(type);
        }

        final String[] names = attr.getAttributeNames();

        byte attrType;

        for (String name : names) {
            attrType = attr.getType(name);

            if ((attrType == CyAttributes.TYPE_FLOATING) ||
                    (attrType == CyAttributes.TYPE_INTEGER))
                attributeComboBox.addItem(name);
        }

        // Assume this calc only returns cont. mapping.
        if (calc.getMapping(0)
                    .getClass() == ContinuousMapping.class) {
            ContinuousMapping mapping = (ContinuousMapping) calc.getMapping(0);
            final String controllingAttrName = mapping.getControllingAttributeName();

            attributeComboBox.setSelectedItem(controllingAttrName);

            final MultiHashMap mhm = attr.getMultiHashMap();

            final CountedIterator it = mhm.getObjectKeys(controllingAttrName);
            Object key;
            maxValue = Double.NEGATIVE_INFINITY;
            minValue = Double.POSITIVE_INFINITY;

            while (it.hasNext()) {
                key = it.next();

                Double val = (Double) mhm.getAttributeValue((String) key,
                        controllingAttrName, null);

                if (val > maxValue)
                    maxValue = val;

                if (val < minValue)
                    minValue = val;

                //System.out.println("************ MHM OBJ= " + val);
            }

            System.out.println("----------- min max = " + minValue + ", " +
                maxValue);

            allPoints = mapping.getAllPoints();
        }
    }

    // Variables declaration - do not modify
    private javax.swing.JButton addButton;
    private javax.swing.JLabel attrNameLabel;
    private javax.swing.JComboBox attributeComboBox;
    protected javax.swing.JButton colorButton;
    private javax.swing.JButton deleteButton;
    protected javax.swing.JPanel iconPanel;
    private javax.swing.JLabel pivotLabel;
    private javax.swing.JPanel rangeEditorPanel;
    private javax.swing.JPanel rangeSettingPanel;
    protected org.jdesktop.swingx.JXMultiThumbSlider slider;
    protected javax.swing.JSpinner valueSpinner;
    private javax.swing.JLabel visualPropertyLabel;
    protected JXMultiThumbSlider rotaryEncoder;

    // End of variables declaration
    protected class ThumbMouseListener
        implements MouseListener {
        public void mouseClicked(MouseEvent e) {
            System.out.println("------------Thumb: ");
        }

        public void mouseEntered(MouseEvent e) {
            // TODO Auto-generated method stub
        }

        public void mouseExited(MouseEvent e) {
            // TODO Auto-generated method stub
        }

        public void mousePressed(MouseEvent e) {
            int selectedIndex = slider.getSelectedIndex();

            if ((0 <= selectedIndex) &&
                    (slider.getModel()
                               .getThumbCount() > 1)) {
                valueSpinner.setEnabled(true);
                valueSpinner.setValue(
                    ((VizMapperTrackRenderer) slider.getTrackRenderer()).getSelectedThumbValue());
            } else {
                valueSpinner.setEnabled(false);
                valueSpinner.setValue(0);
            }
        }

        public void mouseReleased(MouseEvent e) {
            int selectedIndex = slider.getSelectedIndex();

            if ((0 <= selectedIndex) &&
                    (slider.getModel()
                               .getThumbCount() > 1)) {
                valueSpinner.setEnabled(true);
                valueSpinner.setValue(
                    ((VizMapperTrackRenderer) slider.getTrackRenderer()).getSelectedThumbValue());
            } else {
                valueSpinner.setEnabled(false);
                valueSpinner.setValue(0);
            }
        }
    }
}
